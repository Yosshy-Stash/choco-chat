name: Update socket URL hourly

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  update-socket-url:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          persist-credentials: true

      - name: Fetch new URL from raw file
        run: |
          set -euo pipefail

          RAW_URL="https://raw.githubusercontent.com/banana-coco/chat-available-site/refs/heads/main/index.txt"

          NEW_URL="$(curl -fsSL "$RAW_URL" | tr -d '\r\n' | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')"

          if [ -z "$NEW_URL" ]; then
            echo "ERROR: fetched URL is empty" >&2
            exit 1
          fi

          echo "NEW_URL=$NEW_URL" >> $GITHUB_ENV
          echo "Fetched new URL: $NEW_URL"

      - name: Replace URL inside index.html and append history to change.log
        run: |
          set -euo pipefail
          python - <<'PY'
import os, re, sys
from datetime import datetime, timezone

index_path = "index.html"
log_path = "change.log"

if not os.path.exists(index_path):
    sys.exit(1)

new = os.environ.get("NEW_URL", "").strip()
if not new:
    sys.exit(1)

with open(index_path, "r", encoding="utf-8") as f:
    s = f.read()

pattern = re.compile(r"(const\s+socket\s*=\s*io\(\s*')([^']*)(',\s*\{)", re.M)
m = pattern.search(s)
if not m:
    sys.exit(1)

old = m.group(2)

if old == new:
    sys.exit(0)

s2 = pattern.sub(r"\1" + new + r"\3", s, count=1)

with open(index_path, "w", encoding="utf-8") as f:
    f.write(s2)

ts = datetime.now(timezone.utc).strftime("%Y-%m-%d %H:%M:%S UTC")
line = f"[{ts}] {old} -> {new}\n"

with open(log_path, "a", encoding="utf-8") as f:
    f.write(line)

PY

      - name: Commit & push if changed
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add index.html change.log || true

          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "chore: update socket URL from remote index.txt"
            git push origin HEAD
            echo "Changes pushed."
          fi
